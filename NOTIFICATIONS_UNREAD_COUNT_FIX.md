# üî¢ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

## ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –∏ —Ä–µ—à–µ–Ω–∏–µ

### ‚ùå **–ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
–°—á–µ—Ç—á–∏–∫ —Å—á–∏—Ç–∞–ª **–í–°–ï** –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```
–î–∏–∞–ª–æ–≥:
1. üèãÔ∏è user: "–í–æ–ø—Ä–æ—Å 1"
2. üë§ admin: "–û—Ç–≤–µ—Ç 1"  
3. üèãÔ∏è user: "–í–æ–ø—Ä–æ—Å 2"
4. üèãÔ∏è user: "–í–æ–ø—Ä–æ—Å 3"
5. üèãÔ∏è user: "–í–æ–ø—Ä–æ—Å 4"
6. üë§ admin: "–û—Ç–≤–µ—Ç 2"
7. üèãÔ∏è user: "–í–æ–ø—Ä–æ—Å 5"

–°—Ç–∞—Ä—ã–π —Å—á–µ—Ç—á–∏–∫: 2 ‚ùå (—Å—á–∏—Ç–∞–ª "–í–æ–ø—Ä–æ—Å 3", "–í–æ–ø—Ä–æ—Å 5")
```

### ‚úÖ **–°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
–°—á–µ—Ç—á–∏–∫ —Å—á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ** —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–æ–Ω—Ü–∞:

```
–¢–æ—Ç –∂–µ –¥–∏–∞–ª–æ–≥:
7. üèãÔ∏è user: "–í–æ–ø—Ä–æ—Å 5" ‚Üê —Å—á–∏—Ç–∞–µ–º
6. üë§ admin: "–û—Ç–≤–µ—Ç 2" ‚Üê –°–¢–û–ü! –í—Å—Ç—Ä–µ—Ç–∏–ª–∏ –∞–¥–º–∏–Ω–∞

–ù–æ–≤—ã–π —Å—á–µ—Ç—á–∏–∫: 1 ‚úÖ (—Ç–æ–ª—å–∫–æ "–í–æ–ø—Ä–æ—Å 5")
```

## üéØ **–õ–æ–≥–∏–∫–∞ –Ω–æ–≤–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞**

### –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å:
1. **–ü–æ–ª—É—á–∞–µ–º** –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é –≤—Ä–µ–º–µ–Ω–∏)
2. **–ò–¥–µ–º —Å –∫–æ–Ω—Ü–∞** (—Å–∞–º–æ–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
3. **–°—á–∏—Ç–∞–µ–º** —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–¥—Ä—è–¥
4. **–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è** –∫–∞–∫ —Ç–æ–ª—å–∫–æ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞

### –ö–æ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
```typescript
// –°—á–∏—Ç–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–æ–Ω—Ü–∞
let unreadCount = 0;
for (const message of recentMessages) {
  if (message.senderRole === 'user') {
    unreadCount++;
  } else {
    // –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞ - –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º —Å—á–µ—Ç
    break;
  }
}
```

## üìä **–ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã**

### –ü—Ä–∏–º–µ—Ä 1: –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
–î–∏–∞–ª–æ–≥:
1. üèãÔ∏è user: "–ü—Ä–∏–≤–µ—Ç"
2. üë§ admin: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ"
3. üèãÔ∏è user: "–ö–∞–∫ –¥–µ–ª–∞?"
4. üèãÔ∏è user: "–û—Ç–≤–µ—Ç—å—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞"
5. üèãÔ∏è user: "–ñ–¥—É –æ—Ç–≤–µ—Ç–∞"

–ê–ª–≥–æ—Ä–∏—Ç–º:
- –°–æ–æ–±—â–µ–Ω–∏–µ 5: user ‚úì ‚Üí count = 1
- –°–æ–æ–±—â–µ–Ω–∏–µ 4: user ‚úì ‚Üí count = 2  
- –°–æ–æ–±—â–µ–Ω–∏–µ 3: user ‚úì ‚Üí count = 3
- –°–æ–æ–±—â–µ–Ω–∏–µ 2: admin ‚úó ‚Üí –°–¢–û–ü

–†–µ–∑—É–ª—å—Ç–∞—Ç: unreadCount = 3 üî¥
```

### –ü—Ä–∏–º–µ—Ä 2: –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∞
```
–î–∏–∞–ª–æ–≥:
1. üèãÔ∏è user: "–ü—Ä–∏–≤–µ—Ç"
2. üèãÔ∏è user: "–ö–∞–∫ –¥–µ–ª–∞?"
3. üë§ admin: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –≤—Å—ë —Ö–æ—Ä–æ—à–æ!"

–ê–ª–≥–æ—Ä–∏—Ç–º:
- –°–æ–æ–±—â–µ–Ω–∏–µ 3: admin ‚úó ‚Üí –°–¢–û–ü

–†–µ–∑—É–ª—å—Ç–∞—Ç: unreadCount = 0 ‚ö™
```

### –ü—Ä–∏–º–µ—Ä 3: –°–º–µ—à–∞–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥
```
–î–∏–∞–ª–æ–≥:
1. üèãÔ∏è user: "–í–æ–ø—Ä–æ—Å 1"
2. üë§ admin: "–û—Ç–≤–µ—Ç 1"
3. üèãÔ∏è user: "–í–æ–ø—Ä–æ—Å 2"  
4. üë§ admin: "–û—Ç–≤–µ—Ç 2"
5. üèãÔ∏è user: "–°–ø–∞—Å–∏–±–æ!"
6. üèãÔ∏è user: "–ï—â–µ –≤–æ–ø—Ä–æ—Å"

–ê–ª–≥–æ—Ä–∏—Ç–º:
- –°–æ–æ–±—â–µ–Ω–∏–µ 6: user ‚úì ‚Üí count = 1
- –°–æ–æ–±—â–µ–Ω–∏–µ 5: user ‚úì ‚Üí count = 2
- –°–æ–æ–±—â–µ–Ω–∏–µ 4: admin ‚úó ‚Üí –°–¢–û–ü

–†–µ–∑—É–ª—å—Ç–∞—Ç: unreadCount = 2 üî¥
```

## üîß **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**

### –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ API:
```typescript
// 1. –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∏–∞–ª–æ–≥–∞—Ö
const baseConversations = await prisma.$queryRaw`...`;

// 2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤—ã—á–∏—Å–ª—è–µ–º unreadCount
const conversationsWithUnreadCount = await Promise.all(
  baseConversations.map(async (conv) => {
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    const recentMessages = await prisma.feedback.findMany({
      where: { clientId: conv.client_id },
      orderBy: { createdAt: 'desc' },
      take: 50,
      select: { senderRole: true, createdAt: true }
    });

    // –°—á–∏—Ç–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let unreadCount = 0;
    for (const message of recentMessages) {
      if (message.senderRole === 'user') {
        unreadCount++;
      } else {
        break; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–∞
      }
    }

    return { ...conv, unreadCount };
  })
);
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:
- ‚úÖ **–¢–æ—á–Ω–æ—Å—Ç—å** - —Å—á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
- ‚úÖ **–õ–æ–≥–∏—á–Ω–æ—Å—Ç—å** - –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞  
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å 50 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –ø–æ–Ω—è—Ç–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö SQL

## üì± **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ**

### –í —Å–ø–∏—Å–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤:
```
üìû –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤
üí¨ –ö–ª–∏–µ–Ω—Ç: –ñ–¥—É –æ—Ç–≤–µ—Ç–∞ –ø–æ –ø–æ–≤–æ–¥—É...
‚è∞ 14:32
üî¥ 3  ‚Üê –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
```

### –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞:
- **0** ‚ö™ - –ù–µ—Ç –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö / –ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ—Ç –∞–¥–º–∏–Ω–∞
- **1** üî¥ - –û–¥–Ω–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
- **2+** üî¥ - –ö–ª–∏–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥—Ä—è–¥

## üéâ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

–¢–µ–ø–µ—Ä—å —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç **–∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ**:
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ **–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ** –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –£—á–∏—Ç—ã–≤–∞–µ—Ç **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –¥–∏–∞–ª–æ–≥–∞
- –û—Ç—Ä–∞–∂–∞–µ—Ç **—Ä–µ–∞–ª—å–Ω—É—é** –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –æ—Ç–≤–µ—Ç–µ

**–õ–æ–≥–∏—á–Ω–æ, —Ç–æ—á–Ω–æ, –ø–æ–Ω—è—Ç–Ω–æ!** ‚ú®
